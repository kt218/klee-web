{% extends "frontend/base.html" %}

{% block title %}Klee Games{% endblock %}

{% block css %}
<link href="{{ dist }}css/vendor/codemirror/codemirror.css"
      rel="stylesheet">
<link href="{{ dist }}css/vendor/codemirror/theme/neo.css" rel="stylesheet">
<link href="{{ dist }}css/vendor/codemirror/theme/elegant.css" rel="stylesheet">
<link href="{{ dist }}css/vendor/jquery-ui.min.css" rel="stylesheet">
<link href="{{ dist }}css/game.css" rel="stylesheet">
<link href="{{ dist }}css/vendor/highlightjs/styles/github.css" rel="stylesheet">
{% endblock %}

{% block content %}

<div class="wrapper" ng-controller="MainCtrl">
    <!-- Sidebar -->
    <section class="sidebar" ng-controller="SidebarCtrl">
        <header>
            <div class="project-selector">
                <select
                        ng-model="$parent.selectedProject"
                        ng-options="project.name for project in projects
                        {% if not user.is_authenticated %}
                          | filter: {auth:'!false'}
                        {% endif %}"
                        ng-hide="projectToAdd"
                        ng-cloak>
                    <option value="">No Project Selected</option>
                </select>

                <p ng-show="projectToAdd" class="file-input" ng-cloak>
                    <input type="text" ng-model="newProject"
                           ng-enter="addProject(newProject)"
                           focus="[[ projectToAdd ]]"/>
                </p>
            </div>
        </header>

        <div class="current-file">
            <header>
                <h3>Current challenge</h3>
            </header>
            <p ng-cloak><i class="icon_document_alt"></i> [[ challenge.name ||
                'No challenge selected' ]]</p>
        </div>

        <div class="available-files">
            <div class="add-file"
                 ng-if="selectedProject && !selectedProject.example">
                <p>
                    <a href="#" ng-click="showAddFile()" ng-cloak>
                        <i ng-hide="newFile.showForm" class="icon_plus"></i>
                        <span ng-hide="newFile.showForm">Add file...</span>
              <span ng-show="newFile.showForm" class="file-input">
                  <input type="text" ng-model="newFile.name"
                         ng-enter="addFile()" focus="[[ newFile.showForm ]]"
                         ng-blur="newFile.showForm = false"/>
              </span>
                    </a>
                </p>
            </div>

            <ul class="files" ng-hide="projectToAdd">
                <li ng-repeat="challenge in challenges" ng-cloak>
                    <a href="#" ng-click="selectChallenge(challenge)">
                        <i class="icon_document_alt"></i> [[
                        challenge.name|truncate:15 ]]
                    </a>
{#                    TODO: deleteChallenge i.e. reset userSubmission #}
                    <a href="#" class="delete-file" ng-click="deleteFile(file)"
                       ng-if="!selectedProject.example">
                        <i class="icon_close"></i>
                    </a>
                </li>
            </ul>
        </div>

        {% if user.is_authenticated %}
        <form class="upload-file" enctype="multipart/form-data">
            {% csrf_token %}
            <h3>
                <neat-file-uploader uploader="uploader"></neat-file-uploader>
            </h3>
        </form>
        {% endif %}
    </section>

    <!-- Topbar / Navbar -->
    <nav class="topbar">
        <header>
            <a href="/">
                <img src="{{ dist }}img/klee-logo.svg" class="logo" title="KLEE"/>
            </a>
            {% if not user.is_authenticated %}
            <div class="register-area">
                <a href="user/register">Register</a>
            </div>
            {% endif %}
            <div class="login-area">
                {% if user.is_authenticated %}
                <a href="user/logout">Logout</a>
                {% else %}
                <a href="user/login">Login</a>
                {% endif %}
            </div>
            {% if user.is_authenticated %}
            <div class="login-area">
                <a href="user/settings">{{ user.username }}
                  <i class="icon_cogs"></i></a>
            </div>
            {% endif %}
        </header>
    </nav>

    <!-- Left container -->
    <div class="task" ng-controller="TaskMarkedCtrl">
        <div id="mdHtml" ng-bind-html="mdHtml"
             ng-show="$parent.tabs.task.active"></div>
        <div ng-show="$parent.tabs.solution.active">
            <div ui-codemirror id="codemirrorSolution"
                 ng-model="$parent.challenge.solutionCode"
                 ui-refresh="$parent.tabs.solution.active"
                 ui-codemirror-opts="solutionEditorOptions"></div>
        </div>
        <div ng-show="$parent.tabs.main.active">
            <div ui-codemirror id="codemirrorTestfile"
                 ng-model="$parent.challenge.mainCode.code"
                 ui-refresh="$parent.tabs.main.active"
                 ui-codemirror-opts="testfileEditorOptions"></div>
        </div>
    </div>

    <!-- Main container -->
    <form ng-submit="processForm(submission)"
          enctype="multipart/form-data"
          class="{% if messages %} has-error {% endif %}"
          ng-controller="EditorCtrl"
          ng-cloak
          style="display: contents">
        {% csrf_token %}

        <div class="editor main-btns">
            <header>
                <nav class="tabs">
                    <ul>
                        <li ng-class="{active: $parent.tabs.task.active}">
                            <a href="#"
                               ng-click="setTab('task')">Task</a>
                        </li>
                        <li ng-class="{active: $parent.tabs.solution.active}">
                            <a href="#"
                               ng-click="setTab('solution')">Solution</a>
                        </li>
                        <li ng-class="{active: $parent.tabs.main.active}">
                            <a href="#"
                               ng-click="setTab('main')">Test file</a>
                        </li>
                    </ul>
                </nav>

                <button type="submit" id="run-klee-btn"
                        class="btn k-btn run-klee-btn">
                    <i class="arrow_triangle-right"></i> <span>Run Klee</span>
                </button>
            </header>
        </div>

        <div class="editor">
            <ui-codemirror id="codemirror"
                       ng-model="submission.code"
                       ui-codemirror-opts="editorOptions"></ui-codemirror>
        </div>

        {{ form.code.errors }}

    </form>

    <div class="results" ng-cloak>
    <div class="results-inner" ng-controller="ResultTabsCtrl" nanobar>
        <header>
            <nav class="tabs">
                <ul>
                    <li ng-class="{active: tabs.output.active}">
                        <a href="#"
                           ng-click="setTab('output')">Output</a>
                    </li>
                    <li ng-class="{active: tabs.stats.active}">
                        <a href="#"
                           ng-click="setTab('stats')">Stats</a>
                    </li>
                    <li ng-class="{active: tabs.coverage.active}"
                        ng-if="result.coverage">
                        <a href="#"
                           ng-click="setTab('coverage')">Coverage</a>
                    </li>
                    <li ng-class="{active: tabs.replays.active}">
                        <a href="#"
                           ng-click="setTab('replays')">Tests</a>
                    </li>
                    <li ng-class="{active: tabs.testcases.active}">
                        <a href="#"
                           ng-click="setTab('testcases')">Details</a>
                    </li>
                </ul>
            </nav>

            <div class="download action-box"
                 ng-class="{'active': result.url, 'flash-color': result.url}">
                <a href="#" ng-href="[[ result.url ]]"
                   tooltip-placement="bottom"
                   tooltip="Download raw KLEE results.">
                    <i class="icon_cloud-download_alt"></i>
                </a>
            </div>

            <div class="email action-box">
                <a href="#">
                    <i class="icon_mail_alt"></i>
                </a>
            </div>

            <div class="action-box test-nos">
                <a class="test-no" ng-class="{passed: passedNo}">
                    Passed: [[ passedNo ]]
                </a>
                <a class="test-no" ng-class="{failed: failedNo}">
                    Failed: [[ failedNo ]]
                </a>
            </div>

        </header>

        <div class="results-body">
            <div class="tab-body">

                <div class="tab-content-inner klee-output"
                     ng-show="tabs.output.active">
                    <pre class="progress-step code"
                         ng-repeat="step in progress track by $index"
                         ng-cloak>[[ step ]]</pre>

                    <pre class="code klee-command" id="klee-command"
                         ng-if="result.klee_run.command | isNotEmpty">Ran command "[[ result.klee_run.command ]]".</pre>

                    <pre class="code" id="result-output"
                         ng-if="result.klee_run.output | isNotEmpty">[[ result.klee_run.output ]]</pre>

                    <pre class="failed-header code"
                         ng-show="result.failed_tests | isNotEmpty">Failed tests: (more details available in Tests tab)</pre>

                    <div class="failed-tests"
                         ng-if="result.failed_tests | isNotEmpty">
                        <div class="failed-test"
                             ng-repeat="fail in result.failed_tests">
                            <pre class="error-description code">Found in testcase [[ fail.file_no ]]</pre>
                            <pre class="error-description code">[[ fail.reason ]] on line [[ fail.line_no ]].</pre>
                            <pre class="error-line code">[[ fail.line ]]</pre>
                        </div>
                    </div>

                </div>

                <div class="tab-content-inner klee-output"
                     ng-show="tabs.stats.active">
                    <table class="table code">
                        <thead>
                        <tr>
                            <th>Name</th>
                            <th>Value</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr ng-repeat="row in result.stats">
                            <td>[[ row[0] ]]</td>
                            <td>[[ row[1][0] ]]</td>
                        </tr>
                        </tbody>
                    </table>
                </div>


                <div class="tab-content-inner klee-coverage"
                     ng-show="tabs.coverage.active">
                    <pre class="coverage-stats code"> [[ linePercentage ]]% of lines covered.</pre>
                    <div ui-codemirror="{ onLoad : codemirrorLoaded }"
                         ui-refresh="tabs.coverage.active"
                         class="cml-codemirror-refresh"></div>
                </div>

                <div class="tab-content-inner klee-replay"
                     ng-show="tabs.replays.active">
                    <div class="replays" ng-repeat="replay in replays">
                        <pre class="replay-header">Testcase [[ replay.fileNo ]]:</pre>
                        <pre class="replay"
                             ng-class="{'error-description': replay.failed}">[[ replay.inp ]]</pre>
                        <pre class="replay"
                             ng-class="{'error-description': replay.failed}">[[ replay.sol_out ]]</pre>
                        <pre class="replay"
                             ng-class="{'error-description': replay.failed}">[[ replay.your_out ]]</pre>
                    </div>
                </div>

                <div class="tab-content-inner klee-testcases"
                     ng-show="tabs.testcases.active"
                     ng-controller="TestcasesPaginationCtrl">
                    <div class="justify-content-center">
                        <pagination ng-model="currentPage"
                                    total-items="result.test_cases.length"
                                    max-size="maxSize"
                                    boundary-links="true"
                                    items-per-page="1"
                                    class="pagination-sm"
                                    previous-text="&lsaquo;"
                                    next-text="&rsaquo;"
                                    first-text="&laquo;"
                                    last-text="&raquo;">
                        </pagination>
                    </div>
                    <div ng-repeat="desc in result.test_cases[currentPage - 1].desc">
                        <pre class="progress-step code"
                             ng-class="isFailedTest(currentPage)">[[ desc ]]</pre>
                    </div>
                    <table class="table code">
                        <thead>
                        <tr>
                            <th style="width: 30px;"></th>
                            <th>Object #</th>
                            <th>Name</th>
                            <th>Size</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr ng-repeat-start="mem_obj in result.test_cases[currentPage - 1].mem_objs">
                            <td>
{#                                FIXME: fix button styling issue, for some reason can't use css class#}
                                <button style="background: #2f3133; color: #FFFFFF; border-radius: 3px; border-width: 1px"
                                        ng-if="mem_obj.expanded" ng-click="mem_obj.expanded = false">
{#                                    <span class="glyphicon glyphicon-chevron-down"></span>#}
                                    <i class="arrow_triangle-down"></i>
                                    <span class="sr-only"></span>
                                </button>
                                <button style="background: #2f3133; color: #FFFFFF; border-radius: 3px; border-width: 1px"
                                        ng-if="!mem_obj.expanded" ng-click="mem_obj.expanded = true">
{#                                    <span class="glyphicon glyphicon-chevron-right"></span>#}
                                    <i class="arrow_triangle-right"></i>
                                    <span class="sr-only"></span>
                                </button>
                            </td>
                            <td>[[ $index ]]</td>
                            <td>[[ mem_obj.name ]]</td>
                            <td>[[ mem_obj.size ]]</td>
                        </tr>
                        <tr ng-if="mem_obj.expanded" ng-repeat-end="">
                            <td></td>
                            <td colspan="3">
                                <table class="table code">
                                    <tbody>
                                    <tr ng-repeat="rep in mem_obj.representations">
                                        <td>[[ rep[0] ]]</td>
                                        <td>[[ rep[1] ]]</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </div>


</div>

{% endblock %}

{% block javascript %}
<script src="{{ dist }}js/vendor/angular-custom.min.js"></script>
<script src="{{ dist }}js/vendor/codemirror.min.js"></script>
<script src="{{ dist }}js/vendor/ui-codemirror.min.js"></script>
<script src="{{ dist }}js/vendor/angular-bootstrap.min.js"></script>
<script src="{{ dist }}js/vendor/jquery-ui.min.js"></script>
<script src="{{ dist }}js/vendor/angular-ui-slider.min.js"></script>
<script src="{{ dist }}js/vendor/angular-file-upload.min.js"></script>
<script src="{{ dist }}js/vendor/nanobar.min.js"></script>
<script src="{{ dist }}js/vendor/angular-sanitize.min.js"></script>
<script src="{{ dist }}js/vendor/marked.min.js"></script>
<script src="{{ dist }}js/vendor/angular-marked.min.js"></script>
<script src="{{ dist }}js/vendor/highlight.min.js"></script>
<script src="//angular-ui.github.io/bootstrap/ui-bootstrap-tpls-0.12.0.js"></script>

<script src="{{ dist }}js/app.min.js"></script>
{% endblock %}
